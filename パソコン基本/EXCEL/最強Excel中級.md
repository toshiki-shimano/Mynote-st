# Excel中級

## Excelお作法

⓪クロス集計やフィルターがかけやすいように最初のデータの打ち込みは、カラムと行にどのデータを入れるかきちんと把握すること
⇒ピボットテーブルの元表を作成するなら、必ずA行に項目
⇒🔺注意🔺:CSVファイルからデータを取り込んだら、置換削除

①業務上のデータを触る、入力する時はいつでも元の状態に戻せるように連番保存をしてから作業すること

②Excelのデータは、基本列の上下でレコードが変わり、行は同じデータのまとまりを指すように作成する（並び替えもしやすい）

③クロス集計は、絶対に手入力ではなくピボットテーブルを使うこと

## データテーブル

★融資に関わること、リース料金の比較や来期の営業計画を立てる上で、関連する複数の条件を色々と変更しながら十分に試算することが重要であり、その時にはデータテーブルを使い、「感度分析」を実現（複数の条件が変動した場合に結果がどのように変わるかを見る）

◍メモ
⇒月利は、年利を１２で割って出す 月利(%) = 年利(%) / 12
🔶重要🔶：PMT関数は、利率が一定であると仮定した場合の、元利均等の毎月の支払額を計算することができる（元利均等返済）

⇒pmt関数の使用例
⇒PMT(利率, 期間, 現在価値, [将来価値], [支払期日])

=PMT(B1/12, B2*12, B3) 結果：-66,679（pmtだけだとマイナスで表示されるので、-pmtと付けておけばプラス表示になる）

利率(年):2.50%[B1]
借入期間(年):15[B2]
借入金額:10,000,000[B3]

~説明~
1,000万円を年利2.5％の15年ローン、元利均等返済で借りた場合の毎月の支払額を求める。（年利のため12で割って月の利率を求め、借入期間を12倍して月回数にしている。）支払いの場合の計算結果はマイナスで表示される。
⇒なので、pmt関数にマイナスを付けておけばプラスで表示される

◍ミニ豆知識
>借金は利息をつけて支払う。利息は「元金×利率×借り入れをしている期間」で計算されます。貸金業者からの借り入れは利率については年利で表示されていますが、返済は毎月行うのが通常なので、実際に支払う場合には一日ごとの利息を元金と年利で計算して支払う期間を乗じて計算します。
利息は金利・利子といった言葉とイコールです。利息は、元金に一定の割合を掛け算して求めますが、その割合の事を利率と呼びます。貸金業者から借り入れをする場合には、1年で何パーセントの利率となるかという表記をされているため、「年利」という言われ方をします。
貸金業者から借り入れをする際には、返済の際に利息がかかるだけではなく、保証料・手数料といったものが発生することになります。利息も保証料も手数料も貸金業者の利益になるという観点からは変わらないので、こういったものも含めて利息を考えるべきです。そのため、保証料・手数料を含んだ年利の事を実質年率と呼んでいます。
利息の支払いは、（元金×実質年利）÷365×返済までの日数で求めます。
では、年利がわかった場合に実際に支払う利息の額をどのようにして計算するのでしょうか。
この計算は（元金×実質年利）÷365×返済までの日数で求めます。たとえば、元金が50万円で実質年利が16%、30日分の利息を計算する場合には、（500,000×16%）÷365×30＝6,575円になります。
例えばこの条件で一カ月に1万円ずつ返そうとしたら、利息、元本の順に充当されるため、10,000円のうち6,575円が利息として受け取られて、残りの3,425円が元本へ充当されます。ですので、次回の支払いは500,000-3,425＝496,548円を元本として計算をすることになります。
｢利息｣は、元金×金利×借入期間で計算されます。
「元金」とは、借りた金額のこと。元本ともいいます。
「金利」とは、元金に対して一定期間に支払う利息の割合のことです。
実際に利息を計算してみましょう。
例えば、10万円を年利10％で半年間借りるとすると、その利息は次
のようになります。
金利10％は、百分率だと0.1です。
金利は、ふつう「年利」といって１年間の利息の割合で表されるので、
借入期間も年単位にあわせると、半年（ 6ヵ月）は6/12になります。
利息はお金の利用料！
［元金］   ［金利］［借入期間］ ［利息］
10 0,0 0 0円 × 0.1 × 6/12 ＝ 5,0 0 0円
いくらになるか、計算してみよう！
Q8 銀行などの金融機関から30万円を年利10％で1ヵ月間借りたとして、その利息を計算してみましょう。
利息＝元金（ ）円×金利（ ）％×1/100×借入期間（  /12 ）年＝（  ）

～以上を基本としてデータテーブルへ～

* 例として、銀行より融資を受けた時のパターンをそれぞれ見る  

1. 返済期間は3，4，5年のいずれか

2. 借入金額は1000万円、1300万円、1500万円のいずれか

3. 金利は年利2％、月々の返済額は30万円以下に押さえたい

⇒返済期間と借入期間は3 * 3で9パターンある

◍借入金額：10,000,000  
◍金利：2.0%  
◍返済期間：4  
⇒このセルだと毎回1つしか調べることができない。データテーブルを使うと、数式に含まれる１つ、または２つの値が変動した際に、その計算結果がどのように変化するかを一覧で確認できます。今回でいえば、返済期間と借入金額の２つが変動

★データテーブルの作成  
①まず「ある条件での試算結果」を記入した表を作成
⇒PMT(利率（ローンの利率）, 期間（支払回数）, 現在価値（現在の借入金額）, [将来価値], [支払期日]（一回当たりの支払額を求める式）  
⇒=-PMT(F6/12, F7 * 12, F5)  
⇒利率は、月利にしている。期間は、4年なら、12を掛けると何カ月かわかる（つまり両方とも月単位にしている）  

②データテーブル用の表を作成し、見出し列はカラムを、行はレコードになるようにする

|F4|1000万円|1300万円|1500万円|
|---|---|---|---|
|3||||
|4||||
|5||||

⇒F4のちょうど表の左のクロスしたところに、計算して求めた値のセルを入れる

③見出し列と見出し行を含めて範囲選択して、データタブのwhat-if分析のデータテーブルを選択
⇒「Alt」「a」「w」「t」
🔶重要🔶：ここで変更がされる二つの値を指すセルをそれぞれ絶対参照で指定
⇒行に借入金額を書いているなら、行に借入金額の値のセルを絶対参照で入力
⇒行：$F$5、列：$F$7  
⇒すると表にその計算される
🔺注意🔺:表の端っこの値（F4）は削除すると値が全て変わってしまうので、文字色を白にして見えないようにする

★ここでまとめ
⇒データテーブルは、あるno規則性沿って計算された表の一つか二つの値をとって、その値が変更された時の結果をマトリクスに置くことでその値の変更値によって計算をしてくれる。イメージは収支計画表（p218）がわかりやすい
🔶重要🔶：参照元表から選ぶ値は、「ベタ打ちされている数値のみ」（つまり、数式が入力されているセルは選択しない）そして、マトリクスに打つのは、数式。
🔶重要🔶：参照元の表に新たに行や列の挿入をした場合に、その範囲にデータテーブルがあると影響を受けるので、参照元表の右下斜めに作成することがいい

◍参照元表があり
変更される値１
変更される値２
計算結果

◍参照元のデータテーブル
🔹参考🔹：ここに条件付き書式(ホームタブ)で、この値以上は緑。この値以下は赤とするとさらにわかりやすい。

|見たい計算結果|変更される値１の違う値|変更される値１の違う値|変更される値１の違う値|
|---|---|---|---|
|変更される値２の違う値||||
|変更される値２の違う値||||
|変更される値２の違う値||||

～データテーブル補足～

★データテーブルの計算する列や行が10 * 10 くらいになってくると100通りの計算になるのでExcelが非常に重くなる。参照元表がデータテーブルの対象値をどこか変える度に100の計算をするので非常に効率が悪くなる  
⇒これを解決するには、「データテーブルの自動計算をオフにする（数式タブの計算方法でデータテーブル以外を自動にする）  
⇒また、これを再計算できるようにするためには、「再計算実行」を押す。元に戻すには計算方法の自動を選ぶ

## ゴールシーク

★希望の計算値を出すために逆算する機能  
⇒客単価が500円、客数が200人のとき、一日の売り上げは100000円  
⇒では、12万円を達成したい時に必要な客数は何人か？(500x = 120000)  

★データタブでwhat-if分析のゴールシーク（Alt,a,w）  
◍100000  
◍500  
◍200  

⇒数式入力セルは、100000の式があるセルを絶対参照で  
⇒目標値は、自身で設定  
⇒🔶重要🔶：変化させるセルは、つまり実際に目標値を達成するに時に必要な値を死食べたい時に項目を選択する。この場合は200になる
・この中で設定されなかった客単価は固定され、式の結果に対しての部品の中で変更される値を出すことができる
🔺注意🔺:因みに、目標値は、直接入力でセル参照はできない。変化させる値はベタ打ちの数字しか選択できない。

★ゴールシークで役に立つのは、複雑な計算の時！
⇒例えば、利益300万円の収支利益表があり、利益を400万円にしたい（目標値）時に、例えば、一人当たりの人件費をいくらにすればいいか考えたい時（変化させるセル）、、
◍数式入力セル：300万円の式があるセル
◍目標値：自身で設定、400万円
◍変化させるセル：一人当たりの人件費のセル

⇒🔶重要🔶：これで計算ができる。つまり、利益は多くの数式があっての最終的な結果だが、その多くの数式の一部をｘとするのは、自身でそれに関わる数式を徳野は時間がかかるため、便利である。  
🔺注意🔺:つまり、元の数式が正しく計算されていることが絶対条件

★シナリオ機能（データタブのwhat-if分析）
⇒利益収支表である値とある値をこの数字変えたら最終的な利益がどうなるかというシナリオを登録できる。例えば、2018年の材料費率と2019年の材料費率がそれぞれ20％、30％の時という値の登録をしておけば、そのシナリオを呼び出せば、いちいちそのセルを選択して数値を変えなくていい

## ソルバー

★ゴールドシークは変化させる値を設定して、それの結果を得たい数式を設定。そして、その数式に期待する目標値を入力するので、複数の値は扱えない。そこで、求めたい数値が複数ある場合や特定の条件で最適値を求めたい場合にソルバーを利用する  
🔺注意🔺:ソルバーがアドインという追加機能として提供されているので、アドインを有効にしておく（vscodeのプラグイン）  
⇒オプションのアドインで、設定、ソルバーアドインをチェックすると、データタブに追加される

★やり方  

1. 制約条件を表の上部にまとめて記載する  
2. 制約条件に関わる数値を必ず「計算結果のセル」に記載する  
3. バラつきも求めるなら「max(E4:E8) - mix(E4:E8」などのようにしてバラつきも出しておく  
⇒セル範囲をmaxとminを引けばその数の間でどれだけかひらいているかわかる

◍目的セルの設定：求めたい数式のセルを選択  
◍目標値：求めたい値は最大値なのかそれともを選ぶ  
◍変数セルの変更：変化させる値の範囲を選択  
◍制約条件は追加から始める  

🔶重要🔶：この制約条件で何を設定するか  
◍扱う数値で上限をかけたい数値はあるか？  
⇒予算はここまで  
⇒人数は何人まで  
⇒材料費はいくらまで  
⇒原価はどこまでかけられる？  
⇒利益は最低いくらまでは保持するか  

⇒セルの値は整数でないといけない（真ん中をint、右を整数にする）  
⇒各店舗への合計輸送数が各店舗の注文数以上でないといけない（この条件は、目標値が最小値の時に、注文数をクリアした最低限の聴聞数にしてくれる）

★制約条件ルール  
⇒セル参照を範囲選択した時、制約条件も範囲指定したい時は、セル参照と同じセル数ではないとダメ

◍できたら、ソルバーの解の保持をチェックにしたままでＯＫ

## ピボットテーブルとクロス集計

★列に年度、行に製品名を入力して、その交わりに列と行の関係するデータを入力したものをクロス集計という。クロス集計すると各データを個別に確認できるためにデータ分析を正確にできる。  
🔺注意🔺:ただの列がカラムで行がレコードの表はクロス集計ではない。その表から、ある特定の集計を出したい時にクロスさせて集計させる方法。クロス集計を見込んだ表を作成することが大前提

⇒例えば、行に年度だけだと前年より今年の方が販売個数が増えていた場合単純に順調のように見えるが、列にどの商品の販売個数なのかを置くとある一部の商品は上がっているが、別の商品は下がっているのが見て取れたりする。  

🔺注意🔺:クロス集計をする時は入力ミスがあるので、かならずピボットテーブルを使うこと。羅列されたデータをクロス集計し、かつ**マウス操作で分析項目を手軽に変えられる**機能がピボットテーブル。つまり、ピボットテーブルを使うためには、ピボットテーブル用の表を作成しないといけない。ルールとして２つあり

1. セルのA行目に項目名を必ず入れる(空欄があるとエラーになる)  
2. 数値や日付はExcelが正しく読めるように整える（数値を文字列にしない（1個とか一人とかダメ）、日付は2021/5/21の形にする）  
3. もしCSVファイルからデータを取り込んだ時、不要な文字列や数値がある時は、不要な文字列や記号を置換で半角スペースに変えたり、削除する

★ピボットテーブルのやり方（挿入タブより（NとV））

◍最初に正しい範囲が選択されているかチェック(先にCtrlと方向キーで一気に下まで飛んで一番下のデータを確認)  

◍A行の項目を行フィールドと列フィールドに入れていくが、行と値だけでもよい。単純な「商品の金額合計」「商品の販売個数合計」なら、「行」の「値」で出せる

🔺超注意🔺:日付要素に年度以外に日付などがある場合に相当のデータ量がないと年度や四半期表示にならず、時間や分刻みの表示になってしまう。

🔶重要🔶：スライサーの表示  
⇒作成したピボットテーブルにスライサーを表示するとテーブルの必要な要素だけを表示したり消したりできる身にコントローラーできる。  

1. まずピボットテーブを作成（ただし年度別に見るには相当のデータ量が必要）
2. 次に分析タブのスライサーの挿入で表の項目で何で区切りたいかを選択
3. 商品名で区切れば商品名のコントロールができる

★ピボットグラフの出し方

🔺注意🔺:ピボットテーブルのどこでもいいのでセル選択してから、挿入タブのピボットグラフを選ぶ  
⇒列と行の要素を逆にしたい時は、ピボットテーブルタブのデザインから選ぶ  
⇒グラフある状態でスライサーを変えるとグラムも変わる

🔺超注意🔺:ピボットグラフはプレゼン資料などには見た目が良くなく使えないので、ピボットテーブルを値貼り付けの％１２３でペーストしたものを普通のグラフにしたほうがいいかも  
🔺注意🔺:何より注意なのが、ピボットグラフを出さないと行と列の入れ替え表示が出ないので、本体のピボットテーブルの列と行を入れ替えたい時は、先に折れ線グラフをつくってしまう。それから列と行を入れ替え、貼り付けオプションで％１２３でコピーして、普通のグラフ化をする

## 散布図

★散布図の見方について  
⇒表示される斜めの線を回帰直線（近似曲線）という。将来の予測がこの線に近いほど過去の実績の傾向に沿っている。  
⇒表示されるR2 = 0.9816などの数字は相関係数で、１に近いほど強い相関があり、0.5以上で相関性があり、0.7以上で強い相関があるといわれている。  
🔶重要🔶：散布図は、データの量が少ないと効果が薄い。右肩上がりが正の相関。右肩下がりが負の相関（気温が高いと販売個数が下がるなど）

★散布図作成  
⇒挿入タブから散布図で、表示されたら、グラフ上の点を右クリで近似局円の追加で線形近似にして、窓の下にあるグラフのＲ-2乗値を表示するで相関係数が出てくる

★近似曲線の式の利用（y = ax + b）して予測値を知る  
⇒強い相関がある時は、近似曲線よりグラフに数式を表示するをチェックすると式が現れる。例えば、y = 147.23x + 923.05という式が出て、yが売上本数、xが気温なら、気温が例えば30度の売上本数の予測値は、式に当てはめて、約5339本売れるはず  

🔺注意🔺:プロットされた点の中で遠くに外れた点がある場合はそれを含めて近似曲線や式を作成してしまうと本来の相関が小さくなってしまうので、それはグループから外す。  
⇒この時に外れ値を元表から削除するという手は使わない。元表に外れ値用の空欄を作成し、グラフを作成する時は外れ値を含まないでグラフを作成する。  
🔺注意🔺:やり方があって、セルの挿入は表の中にうまくできないときがあり、かつ罫線の外に外れ値の数値を含んでグラフを作成すると変な数値になる（そもそも散布図が2つのデータのみのあつかいなので3つのデータはできない）  
⇒なので、２つのデータで散布図を作成してから元表の端っこを引っ張りしたの外れ値のデータを含めるとできる  
⇒グラフを選択してはじの四角のところで斜め矢印が出たら二回タッチでドラッグできる

★同じ流れのデータでも関東と関西のデータの数値を一緒に散布図で作成してしまうと両データの値広くて相関が得られない時はある。  
⇒なのでそれぞれのレコードをずらして別の行に入力するとそれぞれの近似曲線が作成される

顧客満足度 100 80(こっちが関東)   70 60（こっちが関西）  
売上       1000 3000           4000 1000  

これを

顧客満足度 100 80       70 60  
売上(関東) 1000 3000  
売上(関西)             4000 1000

レコードをずらしてやると二つ作成できる  
🔺注意🔺:これもやはり、一度顧客満足度と売上（関東）だけで散布図を作成し、ドラッグずらしをやれば二つ作成できる。

## 平均値と中央値（median関数）と加重平均

★テストの平均値を出すときに極端な数値に平均値が影響してしまうかもしれないので、あくまでも全体の真ん中である中央値を出すと良し。そして、極端な数値は折れ線グラフなどでも外れ値として発見できる。

★加重平均の注意  
🔺注意🔺:個々の平均値を使って全体の平均値を求めてはいけない。男女40人でテストをして、男子で60点の平均点。女子で80点の平均点だった時に、クラス全体の平均点は(60 + 80) / 2 ではない。各数量に重要度の比例した数値を乗じてから計算したものを加重平均という。この場合、男子が30人、女子が10人なら、、  
⇒(60 *30) + (80* 10) / 40で40は全体の人数。10と30はそれぞれの人数になる。  
⇒加重平均は。sumproduct関数でやる。ただし、どちらとも20人20人だったら比重を掛ける意味はないのでそのまま平均でいい

★sumproduct関数は少し工夫が必要で、割り算はあとでベタ打ちで割るので、掛け算をまとめてやってしまうのがsumproduct関数。  
⇒=sumproduct(平均したい数の全体のセルを範囲指定, 度の比重で割るを最初の引数と同じ位置に対応するように範囲選択)/全体の数  
⇒=sumproduct(60と80というデータ範囲, 最初の60に対応した30と次の80に対応した10という範囲)

🔶重要🔶：この関数は仕事でも重要で、毎回違う値段の違う材料、毎回違う発注量で平均は求められない。  
⇒（1kg当たり）１２００円、１４００円、８００円  
⇒４キロ、６キロ、２キロ  
といった場合、これを毎回それぞれの数値に掛け算していくので大変なので、sumproductで範囲選択して、全体の合計で割る  

🔹参考🔹:例えば100個分の原料または素材を投入し、実際に利益につながった製品が80個、利益にならない欠陥品が20個である場合、歩留まり率は80％です。食品加工などの場合には、一般に原材料の重量から食品に使えない部分や加工で生じるロスを除き、製品になった量の割合を指すため、歩留まり率は100％にはなりません。


## sumifsとグラフ

★「日時で記録されている過去数年の売上データから商品別の売上額を月別に集計したい」ではピボットテーブルだと表のデザインが自由に調整できない。散布図を使えないなどあるときに、一つ一つのデータをsumifsで一気に入れる  
🔶重要🔶：sumifsの検索元を探す照らす範囲のセルで、2019/10/30などのようになっていたら、年度の隣に項目用列を作ってyear関数とmonth関数を使い、その年度を取り出すという手がある。これで一気に何年度かの値が取れるため、集計表の検索元が利用できる。
